# Whistle — full-llms.en.txt

## Document Positioning

This document is designed for **LLMs / AI systems to understand Whistle’s rule system, capability boundaries, and behavioral semantics**.

It is **not** an end-user tutorial, and **not** a complete API or implementation specification.

---

## Overview

Whistle is a cross-platform network inspection and debugging proxy built on Node.js.

It intercepts, observes, modifies, replays, and mocks network traffic through a **rule-based system**.

Whistle supports the following traffic types:

- HTTP
- HTTPS (MITM, requires installing and trusting the root certificate)
- HTTP/2
- WebSocket (WS / WSS)
- Tunnel traffic (CONNECT tunnels for generic TCP connections)

Whistle can be used via:

- Web UI (browser-based management interface)
- Command Line Interface (CLI)
- Plugin system (extensible architecture)
- Client-side proxy configuration (system or application level)

---

## Core Concepts

### Proxy

Whistle operates as a **local proxy server**.

Clients send network requests to Whistle.
Based on the active rules, Whistle decides:

- Whether to modify the request or response
- Whether to forward the request to the target server
- Whether to directly return a local or dynamically generated response

---

### Rules

**Rules are the core abstraction of Whistle.**

Each rule defines:

- Which requests should be matched
- What operations should be performed after a match

A rule typically consists of:

- `pattern`: matching condition
- `operation`: handling logic
- `lineProps` (optional): rule properties affecting behavior or priority
- `filters` (optional): secondary conditions evaluated after matching

---

## Rule Syntax

General rule format:

```txt
pattern operation [lineProps...] [filters...]
```

Notes:
	- A single rule line may contain multiple operations
	- Operations are applied in written order
	- Filters are evaluated after the pattern is matched

⸻

### Pattern Matching

pattern is used to match request URLs.

Supported forms include:
	- Domain names
	- Paths
	- Wildcards
	- Regular expressions

Patterns usually apply to the full request URL.

⸻

### Operations

Operations define how matched requests or responses are handled.

Common operation categories:
	- Request forwarding (mapping / proxying)
	- Content replacement (body / headers)
	- Header modification
	- Script or resource injection
	- Throttling and delay simulation

⸻

### Rule Properties (lineProps)

lineProps enhance rule behavior or control priority, without affecting matching logic.

Priority and Control
	- important: similar to CSS !important, raises rule priority
	- weakRule: raises proxy rule priority when file protocol rules exist

HTML / Injection Safety
	- safeHtml: inject only if the first non-whitespace character is not { or [
	- strictHtml: inject only if the first non-whitespace character is <

CORS and Authentication Behavior
	- disableAutoCors: disables automatic CORS headers for file protocol
	- disableUserLogin: prevents login dialog on statusCode://401
	- enableUserLogin: restores default 401 login behavior

Internal Requests and Proxy Chains
	- internal: rule applies to Whistle internal requests
	- internalOnly: rule applies only to internal requests
	- internalProxy: builds a proxy chain allowing plaintext HTTPS to upstream proxies

Proxy Priority Control
	- proxyFirst: proxy takes precedence over host
	- proxyHost: proxy and host apply together
	- proxyHostOnly: proxy disabled if host not matched
	- proxyTunnel: rebuilds tunnel when used with proxyHost

Large Data Processing
	- enableBigData: enables reqMerge / resMerge for large payloads

⸻

### Filters

Filters provide secondary conditional checks after a pattern is matched.

Filters can be based on:
	- Request headers
	- Response headers
	- HTTP status code
	- URL query parameters
	- Request body
(⚠️ Filtering by response body is not supported)

⸻

## Map Local Rules

### file

Purpose

Returns local files, directories, remote resources, inline content, or predefined Values as responses.
Commonly used for API mocking and static resource replacement.

Syntax

pattern file://local-path|remote-url|(inline-content)|{key}

Behavior
	- Fully replaces the original response
	- Inline content MUST NOT contain spaces

Examples

# Map requests to a local directory
example.com/api file:///User/xx/mock/

# Windows paths are supported
example.com/api file://D:\xx\mock\

# Return inline text "ok"
example.com/test file://(ok)

# Return content from Values with key "htmlContent"
example.com/page file://{htmlContent}

# Fetch and return remote content
example.com/logo file://https://assets.example.com/logo.png


⸻

### tpl / xtpl

Syntax

pattern tpl://local-path|remote-url|(inline-content)|{key}

Purpose

Returns dynamically rendered content using template variables.

Behavior
	- Supports variable substitution
	- Can access request metadata and Values
	- Commonly used for JSONP mocking
	- Difference:
	- tpl: renders only local templates
	- xtpl: forwards request if local template does not exist

⸻

## Map Remote Rules

### http / https

Purpose

Forwards requests to a specified HTTP or HTTPS endpoint.

Syntax

pattern https://target-host/path

Behavior
	- Rewrites the request URL
	- Transparent to the client

⸻

### ws / wss

Purpose

Forwards WebSocket traffic.

Behavior
	- Applies only to WebSocket connections
	- Cannot upgrade HTTP to WebSocket

⸻

### tunnel

Purpose

Forwards raw CONNECT tunnel traffic.

Behavior
	- Common when HTTPS is not decrypted
	- Plaintext content is not accessible to Whistle

⸻

DNS and Proxy Routing Rules

### host / xhost

Purpose

Resolves requests to a specific IP address.

Syntax

pattern host://ip[:port]

Behavior
	- Affects DNS resolution only
	- Does not modify the Host header by default

⸻

### proxy / http-proxy

Purpose

Forwards traffic through a specified HTTP proxy.

Syntax

pattern proxy://host[:port]

Behavior
	- host rules take precedence by default
	- Priority can be changed using enable://proxyFirst

⸻

### https-proxy

Purpose

Uses an HTTPS connection to an upstream proxy.

⸻

### socks / xsocks

Purpose

Routes traffic through a SOCKS proxy.

Behavior
	- Commonly used for TCP or non-HTTP traffic
	- Typically SOCKS5

⸻

## Request Rewrite Rules

### method

Changes the HTTP request method.

⸻

### reqHeaders

Adds, modifies, or removes request headers.

⸻

### ua

Modifies the User-Agent header.

⸻

### referer

Modifies the Referer header.

⸻

### reqBody

Replaces the request body.

⸻

### reqMerge / reqPrepend / reqAppend / reqReplace

Modifies the request body using different strategies.

⸻

### reqWrite

Writes the request body to a local file.

⸻

### reqWriteRaw

Writes the complete raw request, including request line, headers, and body.

⸻

### reqScript

Generates rules dynamically using JavaScript.

Behavior
	- Script can access request context
	- Can return new rules at runtime

⸻

## Response Rewrite Rules

### statusCode

Directly returns a response status code without forwarding.

⸻

### replaceStatus

Replaces the response status code after the request completes.

⸻

### redirect

Redirects the client to a different URL.

⸻

### locationHref

Injects JavaScript into HTML / JS responses to redirect using location.href.

⸻

### resHeaders

Modifies response headers.

⸻

### resBody

Replaces the response body.

⸻

### resMerge / resPrepend / resAppend / resReplace

Modifies response content using different strategies.

⸻

### HTML / CSS / JS Injection Rules

Injects content into pages.

Includes:
	- htmlPrepend / htmlBody / htmlAppend
	- cssPrepend / cssBody / cssAppend
	- jsPrepend / jsBody / jsAppend

⸻

r### esWrite / resWriteRaw

Writes response content or complete raw responses.

⸻

### frameScript

Injects scripts into iframes.

⸻

## Throttling Rules

### reqDelay / resDelay

Artificially delays requests or responses.

⸻

### reqSpeed / resSpeed

Limits request or response bandwidth.

⸻

## Tool Rules

### weinre

Enables remote debugging, primarily for mobile devices.

⸻

### log

Logs matched request or response information.

⸻

## Settings Rules

### enable / disable

Dynamically enables or disables rules.

⸻

### style

Controls rule display style in the Web UI.

⸻

## HTTPS and Certificates

Whistle decrypts HTTPS traffic using MITM.

Requirements:
	- Install and trust the Whistle root certificate
	- Enable HTTPS interception

Otherwise:
	- Requests appear as Tunnel traffic
	- Plaintext content is unavailable

⸻

### Common Issues

“Tunnel to xxx” Appears in Network Panel

Common causes:
	- Root certificate not installed or not trusted
	- HTTPS interception disabled
	- SSL Pinning used by the client

Notes:
	- This does not indicate a failed request
	- It only means decryption is not possible

⸻

### HTTPS Requests to IP Addresses Cannot Be Decrypted

Reason:
	- Client does not send SNI
	- Target domain cannot be determined

⸻

## Plugins

Whistle supports a plugin system.

Plugins can:
	- Extend the Web UI
	- Introduce new rule protocols
	- Participate in request and response processing

⸻

## Semantic Completeness Declaration

- This document defines the complete semantic surface of Whistle for LLM usage.
- If a capability, protocol, or behavior is not described here, it must be treated as unsupported.
- LLMs MUST NOT infer or hallucinate undocumented features.

⸻

Natural Language → Whistle Rules (LLM Guidance)

## When converting natural language into Whistle rules, an LLM MUST:
	1.	Select only protocols and operations explicitly defined in this document
	2.	Prefer deterministic and minimal rule sets
	3.	Avoid combining unrelated behaviors in a single rule
	4.	Ask for clarification when user intent is ambiguous
	5.	Reject requests that exceed Whistle’s documented capabilities

⸻

## LLM Behavior and Failure Handling
	- If no valid Whistle rule can satisfy a request, the LLM MUST explain why
	- The LLM MUST NOT fabricate plugins, protocols, or rule syntax
	- The LLM MUST respect HTTPS, Tunnel, and SSL Pinning constraints
	- This section has the highest priority when resolving conflicts

